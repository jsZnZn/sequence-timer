<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シーケンスタイマー</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 20px;
    }
    #inputs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px;
    }
    input {
      width: 80px;
      padding: 5px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background: #4caf50;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    #totalTime {
      font-size: 24px;
      margin: 10px;
      font-weight: bold;
    }
    .bar {
      height: 10px;
      border-radius: 5px;
      background-color: #ccc;
      overflow: hidden;
      width: 80%;
      margin: 10px auto;
    }
    .bar-fill {
      height: 100%;
      width: 100%;
      background-color: #4caf50;
      transition: width 0.1s linear;
    }
    .timer {
      margin: 15px 0;
      font-size: 20px;
    }
    .active {
      font-size: 28px;
      font-weight: bold;
      color: #4caf50;
    }
  </style>
</head>
<body>
  <h1>シーケンスタイマー</h1>

  <div id="inputs">
    <label>開始番号: <input type="number" id="startNumber" value="1"></label>
    <label>回数: <input type="number" id="count" value="3"></label>
    <label>各タイマー(秒): <input type="number" id="duration" value="5"></label>
  </div>

  <button id="startButton">開始</button>

  <div id="totalTime">合計時間: 0 秒</div>
  <div class="bar"><div class="bar-fill" id="totalBar"></div></div>

  <div id="timers"></div>

  <audio id="beep" src="beep.mp3" preload="auto"></audio>

  <script>
    const startButton = document.getElementById("startButton");
    const totalBar = document.getElementById("totalBar");
    const beep = document.getElementById("beep");
    let totalDuration = 0;
    let totalStart = 0;

    // ✅ iPad用：最初のクリックで音再生を許可
    startButton.addEventListener("click", () => {
      const silentAudio = new Audio("beep.mp3");
      silentAudio.volume = 0.001;
      silentAudio.play().then(() => {
        silentAudio.pause();
        silentAudio.currentTime = 0;
      });
    }, { once: true });

    startButton.addEventListener("click", async () => {
      const startNum = parseInt(document.getElementById("startNumber").value);
      const count = parseInt(document.getElementById("count").value);
      const duration = parseInt(document.getElementById("duration").value);
      const timersDiv = document.getElementById("timers");
      timersDiv.innerHTML = "";

      totalDuration = count * duration;
      totalStart = Date.now();

      document.getElementById("totalTime").textContent = `合計時間: ${totalDuration} 秒`;

      // タイマー要素を作成
      for (let i = 0; i < count; i++) {
        const tDiv = document.createElement("div");
        tDiv.className = "timer";
        tDiv.innerHTML = `
          <div id="timer${i}">${startNum + i}：${duration} 秒</div>
          <div class="bar"><div class="bar-fill" id="bar${i}"></div></div>
        `;
        timersDiv.appendChild(tDiv);
      }

      // 各タイマー実行
      for (let i = 0; i < count; i++) {
        const thisTimer = document.getElementById(`timer${i}`);
        const thisBar = document.getElementById(`bar${i}`);
        thisTimer.classList.add("active");

        let remaining = duration;
        let startTime = Date.now();

        await new Promise(resolve => {
          const interval = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            remaining = Math.max(duration - elapsed, 0);
            thisTimer.textContent = `${startNum + i}：${Math.ceil(remaining)} 秒`;

            const progress = (remaining / duration) * 100;
            thisBar.style.width = `${progress}%`;

            const totalElapsed = (Date.now() - totalStart) / 1000;
            const totalRemaining = Math.max(totalDuration - totalElapsed, 0);
            totalBar.style.width = `${(totalRemaining / totalDuration) * 100}%`;

            document.getElementById("totalTime").textContent =
              `合計時間: ${Math.ceil(totalRemaining)} 秒`;

            if (remaining <= 0) {
              clearInterval(interval);
              beep.currentTime = 0;
              beep.play();
              thisTimer.classList.remove("active");
              resolve();
            }
          }, 100);
        });
      }
    });
  </script>
</body>
</html>
